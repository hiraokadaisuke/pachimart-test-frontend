generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("APP_DATABASE_URL")
}

enum NaviStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED

  @@map("TradeNaviStatus")
}

enum NaviType {
  PHONE_AGREEMENT
  ONLINE_INQUIRY

  @@map("TradeNaviType")
}

enum MessageSenderRole {
  buyer
  seller
}

enum DealingStatus {
  APPROVAL_REQUIRED
  PAYMENT_REQUIRED
  CONFIRM_REQUIRED
  COMPLETED
  CANCELED

  @@map("TradeStatus")
}

enum ExhibitStatus {
  DRAFT
  PUBLISHED
  SOLD

  @@map("ListingStatus")
}

enum RemovalStatus {
  REMOVED
  SCHEDULED
}

enum LedgerEntryCategory {
  PURCHASE
  SALE
  DEPOSIT
  WITHDRAWAL
}

enum LedgerEntryKind {
  PLANNED
  ACTUAL
}

enum LedgerEntrySource {
  TRADE_STATUS_TRANSITION
  MANUAL_ADJUSTMENT
}

enum ExhibitType {
  PACHINKO
  SLOT

  @@map("ListingType")
}

enum OnlineInquiryStatus {
  INQUIRY_RESPONSE_REQUIRED
  ACCEPTED
  DECLINED
  CANCELED
}

model User {
  id               String            @id
  companyName      String
  contactName      String?
  address          String?
  tel              String?
  navisOwned       Navi[]            @relation("NaviOwner")
  navisBought      Navi[]            @relation("NaviBuyer")
  dealingsAsSeller Dealing[]         @relation("TradeSeller")
  dealingsAsBuyer  Dealing[]         @relation("TradeBuyer")
  messagesSent     Message[]         @relation("Sender")
  storageLocations StorageLocation[]
  warehouses       Warehouse[]
}

model Navi {
  id              Int        @id @default(autoincrement())
  status          NaviStatus @default(DRAFT)
  naviType        NaviType   @default(PHONE_AGREEMENT)
  ownerUserId     String
  buyerUserId     String?
  listingId       String?
  listingSnapshot Json?
  payload         Json?
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  ownerUser User      @relation("NaviOwner", fields: [ownerUserId], references: [id])
  buyerUser User?     @relation("NaviBuyer", fields: [buyerUserId], references: [id])
  trade     Dealing?
  messages  Message[]

  @@map("Navi")
}

model Dealing {
  id           Int           @id @default(autoincrement())
  sellerUserId String
  buyerUserId  String
  status       DealingStatus
  paymentAt    DateTime?
  completedAt  DateTime?
  canceledAt   DateTime?
  payload      Json?
  naviId       Int?          @unique
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  sellerUser User  @relation("TradeSeller", fields: [sellerUserId], references: [id])
  buyerUser  User  @relation("TradeBuyer", fields: [buyerUserId], references: [id])
  navi       Navi? @relation(fields: [naviId], references: [id])

  @@map("Dealing")
}

model Message {
  id           Int               @id @default(autoincrement())
  naviId       Int               @map("tradeNaviId")
  senderUserId String
  senderRole   MessageSenderRole
  body         String
  createdAt    DateTime          @default(now())

  senderUser User @relation("Sender", fields: [senderUserId], references: [id])
  navi       Navi @relation(fields: [naviId], references: [id])
}

model OnlineInquiry {
  id                 String              @id @default(cuid())
  listingId          String
  buyerUserId        String
  sellerUserId       String
  body               String
  buyerMemo          String?
  makerName          String?
  productName        String?
  unitPriceExclTax   Int
  quantity           Int
  taxRate            Float               @default(0.1)
  shippingFee        Int                 @default(0)
  handlingFee        Int                 @default(0)
  shippingAddress    String?
  contactPerson      String?
  desiredShipDate    String?
  desiredPaymentDate String?
  status             OnlineInquiryStatus @default(INQUIRY_RESPONSE_REQUIRED)
  createdAt          DateTime            @default(now())
  updatedAt          DateTime            @updatedAt
}

model Exhibit {
  id                      String        @id @default(cuid())
  sellerUserId            String
  status                  ExhibitStatus @default(DRAFT)
  isVisible               Boolean       @default(true)
  type                    ExhibitType   @default(PACHINKO)
  kind                    String
  maker                   String?
  machineName             String?
  quantity                Int
  unitPriceExclTax        Int?
  isNegotiable            Boolean       @default(false)
  removalStatus           RemovalStatus @default(SCHEDULED)
  removalDate             DateTime?
  hasNailSheet            Boolean       @default(false)
  hasManual               Boolean       @default(false)
  pickupAvailable         Boolean       @default(false)
  storageLocation         String
  storageLocationId       String
  storageLocationSnapshot Json?
  shippingFeeCount        Int
  handlingFeeCount        Int
  allowPartial            Boolean
  note                    String?
  createdAt               DateTime      @default(now())
  updatedAt               DateTime      @updatedAt

  storageLocationRecord StorageLocation @relation(fields: [storageLocationId], references: [id])

  @@index([sellerUserId])
  @@index([status])
  @@index([isVisible])
  @@index([updatedAt])
  @@index([storageLocationId])
  @@map("Exhibit")
}

model LedgerEntry {
  id              String             @id @default(cuid())
  userId          String
  tradeId         Int?
  category        LedgerEntryCategory
  kind            LedgerEntryKind    @default(PLANNED)
  amountYen       Int
  occurredAt      DateTime           @default(now())
  counterpartyName String?
  makerName       String?
  itemName        String?
  memo            String?
  balanceAfterYen Int?
  breakdown       Json?
  createdByUserId String
  source          LedgerEntrySource  @default(TRADE_STATUS_TRANSITION)
  tradeStatusAtCreation DealingStatus?
  dedupeKey       String             @unique

  @@index([userId, occurredAt])
  @@index([tradeId])
}

model Maker {
  id            String         @id @default(cuid())
  name          String         @unique
  machineModels MachineModel[]
}

model MachineModel {
  id      String      @id @default(cuid())
  makerId String
  type    ExhibitType
  name    String

  maker Maker @relation(fields: [makerId], references: [id])

  @@unique([makerId, type, name])
  @@index([type])
}

model StorageLocation {
  id                   String   @id @default(cuid())
  ownerUserId          String
  name                 String
  addressLine          String?  @map("address")
  postalCode           String?
  prefecture           String?
  city                 String?
  handlingFeePerUnit   Int?
  shippingFeesByRegion Json?
  isActive             Boolean  @default(true)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  ownerUser User      @relation(fields: [ownerUserId], references: [id])
  exhibits  Exhibit[]

  @@unique([name, ownerUserId])
  @@index([ownerUserId])
  @@index([isActive])
}

model Warehouse {
  id          String   @id @default(cuid())
  ownerUserId String
  name        String
  address     String?
  category    String   @default("self")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  ownerUser User @relation(fields: [ownerUserId], references: [id])

  @@index([ownerUserId])
}

model BuyerShippingAddress {
  id          String   @id @default(cuid())
  ownerUserId String
  label       String?
  companyName String?
  postalCode  String?
  prefecture  String?
  city        String?
  addressLine String?
  tel         String?
  contactName String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([ownerUserId, isActive])
}
