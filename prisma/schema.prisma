generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("PRISMA_DATABASE_URL")
}

enum TradeNaviStatus {
  DRAFT
  SENT
  APPROVED
  REJECTED
}

enum TradeNaviType {
  PHONE_AGREEMENT
  ONLINE_INQUIRY
}

enum TradeStatus {
  IN_PROGRESS
  COMPLETED
  CANCELED
}

enum ListingStatus {
  DRAFT
  PUBLISHED
  SOLD
}

model User {
  id             String     @id
  companyName    String
  contactName    String?
  address        String?
  tel            String?
  tradeNavisOwned TradeNavi[] @relation("TradeNaviOwner")
  tradeNavisBought TradeNavi[] @relation("TradeNaviBuyer")
  tradesAsSeller Trade[]   @relation("TradeSeller")
  tradesAsBuyer  Trade[]   @relation("TradeBuyer")
  messagesSent   Message[] @relation("Sender")
  messagesReceived Message[] @relation("Receiver")
}

model TradeNavi {
  id          Int             @id @default(autoincrement())
  status      TradeNaviStatus @default(DRAFT)
  naviType    TradeNaviType   @default(PHONE_AGREEMENT)
  ownerUserId String
  buyerUserId String?
  listingId   String?
  listingSnapshot Json?
  payload     Json?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  ownerUser User @relation("TradeNaviOwner", fields: [ownerUserId], references: [id])
  buyerUser User? @relation("TradeNaviBuyer", fields: [buyerUserId], references: [id])
  trade     Trade?
  messages  Message[]
}

model Trade {
  id            Int          @id @default(autoincrement())
  sellerUserId  String
  buyerUserId   String
  status        TradeStatus
  payload       Json?
  naviId        Int?         @unique
  createdAt     DateTime     @default(now())
  updatedAt     DateTime     @updatedAt

  sellerUser User   @relation("TradeSeller", fields: [sellerUserId], references: [id])
  buyerUser  User   @relation("TradeBuyer", fields: [buyerUserId], references: [id])
  navi       TradeNavi? @relation(fields: [naviId], references: [id])
}

model Message {
  id             Int       @id @default(autoincrement())
  senderUserId   String
  receiverUserId String
  naviId         Int?
  body           String
  createdAt      DateTime  @default(now())

  senderUser   User      @relation("Sender", fields: [senderUserId], references: [id])
  receiverUser User      @relation("Receiver", fields: [receiverUserId], references: [id])
  navi         TradeNavi? @relation(fields: [naviId], references: [id])
}

model Listing {
  id               String         @id @default(cuid())
  sellerUserId     String
  status           ListingStatus  @default(DRAFT)
  isVisible        Boolean        @default(true)
  kind             String
  maker            String?
  machineName      String?
  quantity         Int
  unitPriceExclTax Int?
  isNegotiable     Boolean        @default(false)
  storageLocation  String
  shippingFeeCount Int
  handlingFeeCount Int
  allowPartial     Boolean
  note             String?
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt

  @@index([sellerUserId])
  @@index([status])
  @@index([isVisible])
  @@index([updatedAt])
}
